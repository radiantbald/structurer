# Описание реализации

## Реализованные компоненты

### Backend (Go)

1. **Модели данных** (`models.go`):
   - `Position` - должность
   - `CustomFieldDefinition` - определение кастомного поля
   - `TreeDefinition` - определение дерева
   - `TreeStructure` - runtime структура дерева
   - `TreeNode` - узел дерева

2. **API Handlers** (`handlers.go`):
   - CRUD операции для Positions
   - CRUD операции для CustomFields
   - CRUD операции для Trees
   - Построение структуры дерева (`GET /api/trees/{id}/structure`)

3. **Построитель дерева** (`tree_builder.go`):
   - Рекурсивное построение дерева на основе TreeDefinition
   - Поддержка plain-списка (пустые levels)
   - Фильтрация позиций по пути в дереве

4. **База данных**:
   - Миграции для создания схемы
   - Индексы для оптимизации запросов
   - Примеры данных для тестирования

### Frontend (React)

1. **Основной layout** (`AppLayout.js`):
   - Разделение на левую (дерево) и правую (детали) панели
   - Управление состоянием выбранной должности

2. **TreePanel** (`TreePanel.js`):
   - Выбор дерева из списка
   - Кнопка создания новой должности
   - Отображение структуры дерева

3. **TreeView** (`TreeView.js`, `TreeNode.js`):
   - Рекурсивное отображение дерева
   - Сворачивание/разворачивание веток
   - Клик по должности для просмотра
   - Кнопка создания должности из узла

4. **PositionDetailsPanel** (`PositionDetailsPanel.js`):
   - Просмотр деталей должности
   - Режим редактирования
   - Управление кастомными полями

5. **PositionForm** (`PositionForm.js`):
   - Форма создания/редактирования должности
   - Управление кастомными полями
   - Валидация полей

## Особенности реализации

### Построение дерева

Дерево строится на лету при запросе `GET /api/trees/{id}/structure`:
1. Загружается TreeDefinition
2. Загружаются все Positions
3. Рекурсивно строится дерево по уровням из TreeDefinition.levels
4. Позиции фильтруются по пути в дереве (path)

### Автозаполнение при создании из узла

При создании должности из узла дерева:
1. Фронтенд передает `path` (объект с ключами кастомных полей и их значениями)
2. В форме создания эти значения автоматически проставляются в `custom_fields`
3. Пользователь может изменить значения перед сохранением

### Plain-список

Если `TreeDefinition.levels` пустой массив:
- Дерево возвращает все позиции как прямые дочерние элементы root
- Сортировка по названию

## API Endpoints

Все endpoints возвращают JSON и используют стандартные HTTP коды.

### Positions
- `GET /api/positions?search=&limit=&offset=` - список с пагинацией и поиском
- `GET /api/positions/{id}` - получить должность
- `POST /api/positions` - создать должность
- `PUT /api/positions/{id}` - обновить должность
- `DELETE /api/positions/{id}` - удалить должность

### Custom Fields
- `GET /api/custom-fields` - список определений полей
- `POST /api/custom-fields` - создать определение поля
- `PUT /api/custom-fields/{id}` - обновить определение (кроме key)
- `DELETE /api/custom-fields/{id}` - удалить (запрещено, если используется в деревьях)

### Trees
- `GET /api/trees` - список деревьев
- `GET /api/trees/{id}` - получить определение дерева
- `GET /api/trees/{id}/structure` - получить структуру дерева (runtime)
- `POST /api/trees` - создать дерево
- `PUT /api/trees/{id}` - обновить дерево
- `DELETE /api/trees/{id}` - удалить дерево (запрещено для default)

## База данных

### Таблицы

1. `positions` - должности
2. `custom_field_definitions` - определения кастомных полей
3. `tree_definitions` - определения деревьев

### Индексы

- `idx_positions_name` - поиск по названию
- `idx_positions_custom_fields` - GIN индекс для JSONB поиска
- `idx_custom_field_definitions_key` - уникальность ключа
- `idx_tree_definitions_is_default` - поиск дефолтного дерева

## Будущие улучшения (не в MVP)

- Управление кастомными полями через UI
- Управление деревьями через UI
- Поиск/фильтрация в дереве
- Экспорт/импорт данных
- Авторизация и роли
- Валидация enum значений при сохранении


